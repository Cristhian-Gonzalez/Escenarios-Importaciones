<!DOCTYPE html>
<html lang="es-PY">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capacitaci√≥n: Compras y Comercio Exterior</title>
    <style>
        :root {
            /* COLORES ORIGINALES DE LA PLANTILLA MAESTRA RESTAURADOS */
            --color-primary: #8DB600;
            --color-primary-dark: #6a8a00;
            --color-text: #333333;
            --color-text-light: #666666;
            --color-background: #f9f9f9;
            --color-card: #ffffff;
            --color-border: #e0e0e0;
            --color-white: #ffffff;
            --color-header-inactive: #d3d3d3;
            --color-header-hover: #bfbfbf;
            --color-role-tag: #b5b5b5;
            --font-family-base: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --border-radius: 8px;
            --transition-speed: 0.3s;
        }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body { font-family: var(--font-family-base); background-color: var(--color-background); color: var(--color-text); line-height: 1.6; }
        .container { max-width: 900px; margin: 0 auto; padding: var(--spacing-lg); }
        header { background-color: var(--color-card); padding: var(--spacing-lg); border-radius: var(--border-radius); margin-bottom: var(--spacing-lg); box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1); }
        .header-top { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: var(--spacing-md); }
        .title-block h1 { color: var(--color-primary-dark); font-size: 1.8rem; margin: 0; line-height: 1.1; }
        .title-block .subtitle { font-size: 1.5rem; color: var(--color-text); margin: 0; line-height: 1.2; font-weight: 600; }
        .version-info { font-size: 0.9rem; font-style: italic; color: var(--color-text-light); white-space: nowrap; margin-left: var(--spacing-md); }
        .controls { display: flex; flex-direction: column; gap: var(--spacing-md); }
        .search-wrapper, .anchor-nav { position: relative; }
        #search-input, #anchor-select { width: 100%; padding: 12px 12px 12px 40px; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; }
        .search-wrapper::before, .anchor-nav::before { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); font-size: 1.2rem; opacity: 0.5; }
        .search-wrapper::before { content: 'üîç'; }
        .anchor-nav::before { content: '‚öì'; pointer-events: none; }
        #anchor-select { cursor: pointer; -webkit-appearance: none; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23cccccc' viewBox='0 0 16 16'%3E%3Cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center;}
        #filters { display: flex; flex-wrap: wrap; gap: var(--spacing-sm); justify-content: center; }
        .filter-btn { background-color: #f0f0f0; color: var(--color-text-light); border: 1px solid var(--color-border); padding: var(--spacing-sm) var(--spacing-md); border-radius: 20px; cursor: pointer; font-size: 0.9rem; transition: all var(--transition-speed); display: inline-flex; align-items: center; gap: var(--spacing-sm); }
        .filter-btn:hover { background-color: #cccccc; color: var(--color-text); }
        .filter-btn.active { background-color: var(--color-primary); color: var(--color-white); border-color: var(--color-primary-dark); font-weight: bold; }
        .icon { width: 18px; height: 18px; }
        .filter-btn.active .icon { filter: brightness(0) invert(1); }
        #scenarios-container { display: grid; gap: var(--spacing-md); }
        .scenario { background-color: var(--color-card); border: 1px solid var(--color-border); border-radius: var(--border-radius); overflow: hidden; }
        .scenario-header { padding: var(--spacing-md) var(--spacing-lg); cursor: pointer; display: flex; justify-content: space-between; align-items: center; gap: var(--spacing-md); transition: background-color var(--transition-speed); background-color: var(--color-header-inactive); }
        .scenario-header:hover { background-color: var(--color-header-hover); }
        .scenario-title { font-size: 1.1rem; font-weight: 600; flex-grow: 1; }
        .scenario-role { display: flex; align-items: center; gap: var(--spacing-sm); font-size: 0.9rem; color: var(--color-white); background-color: var(--color-role-tag); padding: 4px var(--spacing-sm); border-radius: 12px; white-space: nowrap; }
        .scenario-header::after { content: '‚ñº'; font-size: 0.8rem; transition: transform var(--transition-speed); color: var(--color-text-light); }
        .scenario.open > .scenario-header::after { transform: rotate(180deg); }
        .scenario-content { display: grid; grid-template-rows: 0fr; transition: grid-template-rows var(--transition-speed) ease-in-out; }
        .scenario.open > .scenario-content { grid-template-rows: 1fr; }
        .scenario-content-inner { overflow: hidden; padding: 0 var(--spacing-lg); }
        .scenario.open .scenario-content-inner { padding: var(--spacing-lg); border-top: 1px solid var(--color-border); }
        .situation { margin-bottom: var(--spacing-md); padding-left: var(--spacing-md); border-left: 3px solid var(--color-primary); }
        .situation h3, .solution h3 { font-size: 1rem; margin-bottom: var(--spacing-sm); color: var(--color-primary-dark); }
        .solution-toggle { background-color: var(--color-primary); color: var(--color-white); border: none; padding: 10px 15px; border-radius: var(--border-radius); cursor: pointer; font-size: 0.9rem; font-weight: bold; transition: background-color var(--transition-speed); margin-bottom: var(--spacing-md); }
        .solution-toggle:hover { background-color: var(--color-primary-dark); }
        .solution { background-color: rgba(141, 182, 0, 0.05); border: 1px solid rgba(141, 182, 0, 0.2); border-radius: var(--border-radius); padding: var(--spacing-md); }
        .solution ul { list-style-position: inside; padding-left: var(--spacing-sm); }
        .solution ul li { margin-bottom: var(--spacing-sm); }
        [hidden] { display: none !important; }
        .floating-actions { position: fixed; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: var(--spacing-md); z-index: 110; }
        .fab { background-color: var(--color-primary); color: white; border: none; border-radius: 50%; width: 50px; height: 50px; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.2); display: grid; place-items: center; transition: opacity 0.3s, transform 0.3s; opacity: 0; transform: scale(0.8); pointer-events: none; }
        .fab.visible { opacity: 1; transform: scale(1); pointer-events: auto; }
        .fab:hover { background-color: var(--color-primary-dark); transform: scale(1.05); }
        @media (max-width: 600px) { .header-top { flex-direction: column; align-items: flex-start; } .scenario-header { flex-direction: column; align-items: flex-start; } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-top">
                <div class="title-block">
                    <h1>Compras y Comercio Exterior</h1>
                    <p class="subtitle">Manual de Entrenamiento GEMS</p>
                </div>
                <span class="version-info">PG-CM-04 (2025)</span>
            </div>
            <div class="controls">
                <div class="search-wrapper"><input type="search" id="search-input" placeholder="Buscar por palabra clave..."></div>
                <div class="anchor-nav"><select id="anchor-select"></select></div>
                <div id="filters"></div>
            </div>
        </header>
        <main id="scenarios-container"></main>
    </div>
    <div class="floating-actions">
        <button id="close-all-btn" class="fab" title="Cerrar todos los escenarios"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg></button>
        <button id="back-to-top" class="fab" title="Volver arriba"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19V5M5 12l7-7 7 7"/></svg></button>
    </div>
    <script>
    const scenarios = [
        {
            "id": 1,
            "title": "El C√≥digo Nuevo (Sin Padrinos)",
            "roles": ["Importaciones"],
            "situation": "Marketing pide traer 'L√°minas UV Premium' urgentes. El Asistente de Importaciones crea un c√≥digo gen√©rico 'LAMINAS-001' y carga el pedido para ganar tiempo.",
            "solution": "El IT-CM-02 exige 'coordinar con el Gerente Comercial T√©cnico para acordar la descripci√≥n'. Crear c√≥digos basura ensucia la base de datos y complica el despacho aduanero posterior (clasificaci√≥n arancelaria incorrecta)."
        },
        {
            "id": 2,
            "title": "La Proforma con Extras (Flete Incluido)",
            "roles": ["Importaciones"],
            "situation": "El proveedor chino env√≠a una Proforma que dice 'TOTAL CFR ASUNCION: $10,000'. El Asistente carga el pedido en el sistema poniendo $10,000 como costo de la mercader√≠a (FOB).",
            "solution": "Error Operativo: Inflaci√≥n del costo del producto e impuestos incorrectos. Se debe prorratear y separar el costo del flete (CFR = Cost + Freight) del valor FOB para la correcta liquidaci√≥n de impuestos en Aduana."
        },
        {
            "id": 3,
            "title": "El Proveedor Fantasma (Pago Bloqueado)",
            "roles": ["Compras"],
            "situation": "Se aprueba una compra urgente a un nuevo proveedor en India. El Asistente carga el pedido y pide el Swift a Tesorer√≠a. Tesorer√≠a dice: 'No puedo pagar, no existe en el sistema'. Se pierden 3 d√≠as.",
            "solution": "Antes de pedir el pago, el Asistente debe realizar el Alta de Proveedores (Paso 2.1), registrar los datos en el sistema y solicitar al Auxiliar Contable la asignaci√≥n de la cuenta contable."
        },
        {
            "id": 4,
            "title": "Las Muestras de Regalo",
            "roles": ["Importaciones"],
            "situation": "El proveedor avisa por WhatsApp: 'Les puse 50 gorras de regalo en el contenedor'. El Asistente dice 'Gracias' y no hace nada m√°s porque 'es gratis'.",
            "solution": "Aunque sea costo cero, debe registrarse en el pedido (Caso 1.3). Al registrar el despacho, ingresar√°n al sistema con costo cero, pero deben estar declarados para evitar multas por contrabando."
        },
        {
            "id": 5,
            "title": "El Estatus Congelado",
            "roles": ["Importaciones"],
            "situation": "Vendedor pregunta: '¬øCu√°ndo llegan los plotters?'. Sistema dice: 'Producci√≥n'. El Asistente responde: 'Ah no, eso ya sali√≥ hace 2 semanas, est√° en el barco'.",
            "solution": "El Asistente debe actualizar la Planilla de Importaciones y enviar el informe semanal por correo electr√≥nico al Gerente Comercial y Log√≠stica (PG-CM-04). El sistema debe reflejar la realidad (Tr√°nsito, Puerto, etc.)."
        },
        {
            "id": 6,
            "title": "Descarga Nocturna (Sin Testigos)",
            "roles": ["Dep√≥sito"],
            "situation": "El contenedor llega a las 19:00. El Encargado de Dep√≥sito se queda solo a descargar para 'sacar el trabajo r√°pido'. Termina y se va a casa.",
            "solution": "La norma exige confeccionar la Planilla de Desestiba y, si es fuera de horario, 'solicita la firma de la planilla a los participantes'. Descargar solo rompe la cadena de custodia."
        },
        {
            "id": 7,
            "title": "La Caja Mojada",
            "roles": ["Dep√≥sito"],
            "situation": "Al abrir el contenedor, se ven cajas h√∫medas al fondo. El Encargado descarga todo, seca las cajas y las guarda. Al d√≠a siguiente informa verbalmente en el almuerzo.",
            "solution": "Se deben 'tomar fotograf√≠as del estado en que llega la carga' (Paso 1.8.1) y emitir el Informe de Desestiba detallando el da√±o inmediatamente (Paso 1.8.4). Sin fotos in situ, el seguro no paga."
        },
        {
            "id": 8,
            "title": "Sobrante de Mercader√≠a",
            "roles": ["Dep√≥sito"],
            "situation": "Pedimos 100 unidades. Llegaron 105. El Encargado de Dep√≥sito ingresa 100 al sistema para que 'cuadre con la factura' y deja 5 aparte en un estante.",
            "solution": "Se debe reportar la diferencia. El IT-CM-02 indica que 'se corrige el pedido con el fin de distribuir el costo... de forma homog√©nea'. Las 105 unidades deben ingresar al sistema prorrateando el costo total pagado."
        },
        {
            "id": 9,
            "title": "Llegada Sorpresa",
            "roles": ["Importaciones", "Log√≠stica"],
            "situation": "Un cami√≥n con mercader√≠a local llega al dep√≥sito central. El dep√≥sito est√° lleno, no hay espacio en los racks. El chofer espera 4 horas.",
            "solution": "El Asistente de Importaciones/Compras debi√≥ informar al Coordinador de Log√≠stica sobre la previsi√≥n de llegada 'con el fin de prever el espacio de almacenamiento' antes de que el cami√≥n salga."
        },
        {
            "id": 10,
            "title": "El Dep√≥sito Incorrecto",
            "roles": ["Importaciones"],
            "situation": "La mercader√≠a se descarg√≥ f√≠sicamente en la Sucursal Ciudad del Este. El Asistente registra el Invoice en el sistema asignando 'Dep√≥sito Central Asunci√≥n'.",
            "solution": "'En caso de que se tenga que cambiar el dep√≥sito luego de haber registrado el Invoice, se deber√° anular y volver a registrar'. No se debe hacer una transferencia simple sin corregir el ingreso original, pues afecta las cuentas contables de inventario por sucursal."
        },
        {
            "id": 11,
            "title": "La Tasa de Cambio (Invoice vs. Despacho)",
            "roles": ["Importaciones"],
            "situation": "El Asistente registra el Invoice usando el tipo de cambio del d√≠a que carg√≥ el pedido (7.200). El Despacho sale con cambio 7.400. Cierra la operaci√≥n as√≠.",
            "solution": "El IT-CM-01 es estricto: El Tipo de Cambio para el Invoice y el Despacho debe ser el de la 'Fecha de la Hoja de Aduana'. Se debe ajustar al oficial del despacho para que los impuestos en guaran√≠es coincidan con la liquidaci√≥n de la DNA."
        },
        {
            "id": 12,
            "title": "El Prorrateo Olvidado (Flete Pre-Pagado)",
            "roles": ["Importaciones"],
            "situation": "El flete internacional se pag√≥ hace 2 meses (Prepaid). Al cerrar el despacho, el Asistente carga los gastos del despachante pero olvida incluir el flete porque 'ya se pag√≥'.",
            "solution": "Se debe verificar 'FLETES PAGADOS POR ADELANTADO' y cargarlos en la columna de gastos del despacho para que el sistema prorratee ese costo sobre los productos. Si no, el producto parece m√°s barato de lo que realmente cost√≥ ponerlo en dep√≥sito."
        },
        {
            "id": 13,
            "title": "Arancel Promedio (La Pereza)",
            "roles": ["Importaciones"],
            "situation": "El despacho tiene 50 √≠tems. 20 pagan 2% de arancel, 30 pagan 10%. El Asistente carga un gasto √∫nico de 'Derechos Aduaneros' y deja que el sistema lo reparta por valor total.",
            "solution": "'Verificar si existe Derecho aduanero para ir distribuyendo por cada art√≠culo su arancel correspondiente'. Se debe asignar manualmente el costo exacto de impuestos a cada l√≠nea seg√∫n la Hoja de Aduana."
        },
        {
            "id": 14,
            "title": "Diferencia de Factura y Despacho",
            "roles": ["Importaciones"],
            "situation": "El Invoice del sistema dice $10,000. La Hoja de Aduana dice $10,050 (por un ajuste de seguro de aduana). El Asistente guarda as√≠ sin ajustar.",
            "solution": "Se debe realizar el control: 'El valor total del invoice del sistema contra el documento'. Si hay diferencias, deben reflejarse como gastos de ajuste para que la base imponible del sistema cuadre exactamente con la Aduana."
        },
        {
            "id": 15,
            "title": "La Firma Fantasma",
            "roles": ["Importaciones", "Compras"],
            "situation": "El Asistente imprime el reporte de Despacho del sistema, le pone un clip y lo manda directo a Contabilidad para archivar.",
            "solution": "Debe imprimir 2 copias y hacer firmar al Jefe de Compras. Esa firma valida que los costos ingresados son correctos. Contabilidad no deber√≠a recibir despachos sin esa firma."
        },
        {
            "id": 16,
            "title": "El Proveedor Tard√≥n (Evaluaci√≥n)",
            "roles": ["Compras"],
            "situation": "Un proveedor entrega tarde por 3ra vez consecutiva. Ventas se queja. Compras dice: 'Es lo que hay, es el √∫nico que tiene stock'.",
            "solution": "El Jefe de Compras debe calificar la 'Disponibilidad/Tiempo de entrega'. Si es 'Casi nunca cumple' (Calificaci√≥n 2), y el promedio baja del 60%, se debe poner a consideraci√≥n de la Gerencia Comercial la continuidad del proveedor o buscar alternativas."
        },
        {
            "id": 17,
            "title": "Documentos Originales Perdidos",
            "roles": ["Importaciones", "Dep√≥sito"],
            "situation": "Se perdi√≥ el Invoice original en el trayecto. Solo hay copia escaneada. El dep√≥sito ya verific√≥ la carga. El Asistente no registra nada 'esperando el original'.",
            "solution": "El IT permite: 'Si no se tienen los documentos originales, se procede a registrar con las copias, siempre y cuando se tenga la verificaci√≥n del dep√≥sito'. No se debe detener el ingreso al sistema."
        },
        {
            "id": 18,
            "title": "Compra Local como Importaci√≥n",
            "roles": ["Importaciones", "Compras"],
            "situation": "Se compra mercader√≠a a un proveedor local (Asunci√≥n) pero en D√≥lares. El Asistente tilda 'Proveedor del Exterior' en el sistema porque la factura es en USD.",
            "solution": "Si es proveedor local, aunque sea en d√≥lares: 'tilda REPORTE y se destilda EXENTA' (a menos que sea zona franca). Configurar mal el tipo de proveedor afecta la generaci√≥n autom√°tica de los libros de Compras impositivos."
        },
        {
            "id": 19,
            "title": "Anticipo sin Aplicar",
            "roles": ["Compras"],
            "situation": "Se pag√≥ $5,000 de anticipo. Lleg√≥ la carga. Se cerr√≥ el despacho. En el estado de cuenta del proveedor siguen figurando los $5,000 a favor flotando por meses.",
            "solution": "'Todos los anticipos deben ser aplicados en la fecha del despacho registrado'. Tesorer√≠a o Contabilidad deben cruzar el anticipo contra la factura final en el m√≥dulo 'Movimientos de Caja' inmediatamente al cerrar el despacho."
        },
        {
            "id": 20,
            "title": "Retenci√≥n de Renta Ignorada",
            "roles": ["Importaciones"],
            "situation": "El Despachante incluye 'Retenci√≥n Renta' en su liquidaci√≥n. El Asistente lo carga como un 'Gasto Vario' (Concepto 20) sumado a las fotocopias.",
            "solution": "El instructivo especifica: 'Se coloca aparte el gasto de RETENCION RENTA IRE' o se usa el concepto espec√≠fico (C√≥d 64 en el ejemplo). Esto alimenta cuentas contables de impuestos (Activo/Pasivo fiscal), no de costo directo simple."
        }
    ];

    document.addEventListener('DOMContentLoaded', () => {
        const scenariosContainer = document.getElementById('scenarios-container');
        const searchInput = document.getElementById('search-input');
        const filtersContainer = document.getElementById('filters');
        const anchorSelect = document.getElementById('anchor-select');
        const backToTopButton = document.getElementById('back-to-top');
        const closeAllButton = document.getElementById('close-all-btn');
        let activeFilter = 'Todos';
        const SESSION_STORAGE_KEY = 'openScenariosCompras';
        
        const icons = {
            "Importaciones": `<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 21c-1.39 0-2.78-.47-4-1.32-2.44 1.71-5.56 1.71-8 0C6.78 20.53 5.39 21 4 21H2v2h2c1.38 0 2.74-.35 4-.99 2.52 1.29 5.48 1.29 8 0 1.26.65 2.62.99 4 .99h2v-2h-2zM3.95 19H4c1.6 0 3.02-.88 4-2 .98 1.12 2.4 2 4 2s3.02-.88 4-2c.98 1.12 2.4 2 4 2h.05l.02-1.91C18.49 16.61 17.37 15.92 16.5 15c-1.31-1.38-3.07-1.36-4.22-.16l-1.55 1.62L9.22 14.9C8.07 13.7 6.31 13.72 5 15.1c-.87.92-1.99 1.61-3.57 2.09L3.95 19zM6 6v2.34l2 1V5H6zm8.8 1.8l2-1V5h-2v2.8zm-4.4 2.2l2-1V5h-2v4zM18 1L6 4.6V5h12V1z"/></svg>`,
            "Compras": `<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>`,
            "Log√≠stica": `<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M18 1c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zm0 8c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zM6 1C3.24 1 1 3.24 1 6s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zm0 8c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm12 6H6c-2.76 0-5 2.24-5 5v3h22v-3c0-2.76-2.24-5-5-5zm-12 6c0-1.66 1.34-3 3-3h10c1.66 0 3 1.34 3 3v1H6v-1z"/></svg>`,
            "Dep√≥sito": `<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 8h-3V4H7v4H4c-1.1 0-2 .9-2 2v10h20V10c0-1.1-.9-2-2-2zM9 6h6v2H9V6zm11 12H4v-3h2v1h2v-1h8v1h2v-1h2v3zm-5-5H8v-2h8v2z"/></svg>`
        };
        const getIconForRole = (role) => icons[role] || '';
        
        const renderScenarios = (scenariosToRender) => {
            scenariosContainer.innerHTML = '';
            scenariosToRender.forEach(s => {
                const scenarioEl = document.createElement('article');
                scenarioEl.className = 'scenario';
                scenarioEl.dataset.id = s.id;
                scenarioEl.id = `escenario-${s.id}`;
                scenarioEl.innerHTML = `
                    <header class="scenario-header" role="button" aria-expanded="false"><h2 class="scenario-title">${s.id}: ${s.title}</h2><div class="roles-wrapper">${s.roles.map(r => `<span class="scenario-role">${getIconForRole(r)}${r}</span>`).join('')}</div></header>
                    <div class="scenario-content">
                        <div class="scenario-content-inner">
                            <div class="situation"><h3>Situaci√≥n</h3><p>${s.situation}</p></div>
                            <button class="solution-toggle" aria-expanded="false">Ver Soluci√≥n Recomendada</button>
                            <div class="solution" hidden><h3>Soluci√≥n Recomendada</h3><ul>${s.solution.split('\n').map(l => `<li>${l}</li>`).join('')}</ul></div>
                        </div>
                    </div>`;
                scenariosContainer.appendChild(scenarioEl);
            });
        };
        
        const renderFilters = () => {
            const allRoles = [...new Set(scenarios.flatMap(s => s.roles))];
            let filtersHtml = `<button class="filter-btn active" data-role="Todos">Todos</button>`;
            allRoles.sort().forEach(role => { filtersHtml += `<button class="filter-btn" data-role="${role}">${getIconForRole(role)}${role}</button>`; });
            filtersContainer.innerHTML = filtersHtml;
        };
        
        const renderAnchorNav = () => {
            anchorSelect.innerHTML = '<option value="">Saltar a un escenario...</option>';
            scenarios.forEach(s => { const o = document.createElement('option'); o.value = s.id; o.textContent = `${s.id}: ${s.title}`; anchorSelect.appendChild(o); });
        };
        
        const filterAndSearch = () => {
            const searchTerm = searchInput.value.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            let filtered = scenarios.filter(s => activeFilter === 'Todos' || s.roles.includes(activeFilter));
            if (searchTerm) {
                filtered = filtered.filter(s => Object.values(s).join(' ').toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").includes(searchTerm));
            }
            renderScenarios(filtered);
            loadState();
        };
        
        const saveState = () => { sessionStorage.setItem(SESSION_STORAGE_KEY, JSON.stringify(Array.from(document.querySelectorAll('.scenario.open')).map(el => el.dataset.id))); };
        const loadState = () => { JSON.parse(sessionStorage.getItem(SESSION_STORAGE_KEY) || '[]').forEach(id => { const el = document.querySelector(`.scenario[data-id='${id}']`); if (el) { el.classList.add('open'); el.querySelector('.scenario-header').setAttribute('aria-expanded', 'true'); } }); };
        
        // Listener de b√∫squeda
        searchInput.addEventListener('input', filterAndSearch);
        
        filtersContainer.addEventListener('click', e => { if (e.target.closest('.filter-btn')) { filtersContainer.querySelector('.active').classList.remove('active'); e.target.closest('.filter-btn').classList.add('active'); activeFilter = e.target.closest('.filter-btn').dataset.role; filterAndSearch(); } });
        anchorSelect.addEventListener('change', e => { if (e.target.value) { const target = document.getElementById(`escenario-${e.target.value}`); if (target) { if (!target.classList.contains('open')) { target.querySelector('.scenario-header').click(); } target.scrollIntoView({ behavior: 'smooth', block: 'center' }); } e.target.selectedIndex = 0; } });
        closeAllButton.addEventListener('click', () => { document.querySelectorAll('.scenario.open').forEach(s => { s.classList.remove('open'); s.querySelector('.scenario-header').setAttribute('aria-expanded', 'false'); }); sessionStorage.removeItem(SESSION_STORAGE_KEY); });
        scenariosContainer.addEventListener('click', e => { const header = e.target.closest('.scenario-header'); if (header) { const s = header.parentElement; s.classList.toggle('open'); header.setAttribute('aria-expanded', s.classList.contains('open')); saveState(); } const solToggle = e.target.closest('.solution-toggle'); if (solToggle) { const solDiv = solToggle.nextElementSibling; const isExp = solToggle.getAttribute('aria-expanded') === 'true'; solToggle.setAttribute('aria-expanded', !isExp); solDiv.hidden = isExp; solToggle.textContent = isExp ? 'Ver Soluci√≥n' : 'Ocultar Soluci√≥n'; } });
        
        const checkScroll = () => { backToTopButton.classList.toggle('visible', document.documentElement.scrollTop > 100); closeAllButton.classList.toggle('visible', document.querySelector('.scenario.open') !== null); };
        window.addEventListener('scroll', checkScroll);
        scenariosContainer.addEventListener('click', () => setTimeout(checkScroll, 350));
        closeAllButton.addEventListener('click', () => setTimeout(checkScroll, 350));
        backToTopButton.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
        
        renderFilters(); renderAnchorNav(); renderScenarios(scenarios); loadState(); checkScroll();
    });
    </script>
</body>
</html>
